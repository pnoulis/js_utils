function c({logLevel:e="trace"}={}){this.logLevel=this.levels[e]}c.prototype.levels={trace:5,debug:4,info:3,warn:2,error:1,fatal:0,silent:-1};c.prototype.trace=function(...t){this.logLevel<this.levels.trace};c.prototype.debug=function(...t){this.logLevel<this.levels.debug};c.prototype.info=function(...t){this.logLevel<this.levels.info};c.prototype.warn=function(...t){this.logLevel<this.levels.warn};c.prototype.error=function(...t){this.logLevel<this.levels.error};c.prototype.fatal=function(...t){this.logLevel<this.levels.fatal};function y(e,t){return Math.floor(Math.random()*(t-e)+e)}function A(){let e=["admiring","adoring","affectionate","agitated","amazing","angry","awesome","beautiful","blissful","bold","boring","brave","busy","charming","clever","cool","compassionate","competent","condescending","confident","cranky","crazy","dazzling","determined","distracted","dreamy","eager","ecstatic","elastic","elated","elegant","eloquent","epic","exciting","fervent","festive","flamboyant","focused","friendly","frosty","funny","gallant","gifted","goofy","gracious","great","happy","hardcore","heuristic","hopeful","hungry","infallible","inspiring","intelligent","interesting","jolly","jovial","keen","kind","laughing","loving","lucid","magical","mystifying","modest","musing","naughty","nervous","nice","nifty","nostalgic","objective","optimistic","peaceful","pedantic","pensive","practical","priceless","quirky","quizzical","recursing","relaxed","reverent","romantic","sad","serene","sharp","silly","sleepy","stoic","strange","stupefied","suspicious","sweet","tender","thirsty","trusting","unruffled","upbeat","vibrant","vigilant","vigorous","wizardly","wonderful","xenodochial","youthful","zealous","zen"],t=["Aragorn","Arwen","Balin","Bard","Beorn","Beren","Baggins","Bilbo","Boromor","Celeborn","Celebrimbor","Denethor","Earendil","Elwing","Elendil","Elrond","Eomer","Eowyn","Faramir","Feanor","Fingolfin","Finrod","Finwe","Frodo","Galadriel","Gandalf","Gilgalad","Glorfindel","Gimli","Goldberry","Gollum","Grima","Wormtongue","Hurin","Isildur","Kili","Legolas","Luthien","Maedhros","Melian","Merry","Morgoth","Pippin","Radagast","Samwise","Saruman","Sauron","Shelob","Smaug","Smeagol","Theoden","Thingol","Thranduil","Thorin","Tom","Treebeard","Tuor","Idril","Turin","Ungoliant"];return`${e[y(0,e.length)]}_${t[y(0,t.length)]}`}import X from"is-number";function O(e){let t={};for(let n in e)if(typeof e[n]=="object"&&!Array.isArray(e[n])){let r=O(e[n]);for(let i in r)t[n+"."+i]=r[i]}else t[n]=e[n];return t}function w(...e){return e.length>1?e.map(t=>t.charAt(0).toUpperCase()+t.slice(1)):e[0].charAt(0).toUpperCase()+e[0].slice(1)}function Y(e=0,t=25e3){return Math.floor(Math.random()*(t-e+1))+e}function ee(e,t){return Math.random()*(t-e+1)+e}function R(e){for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++)if(e[t]===e[n])return!1;return!0}function te(e,t){for(let n=0;n<e.length;n++)for(let r=n+1;r<e.length;r++)if(t(e[n],e[r]))return!1;return!0}function ne(e){return!R(e)}function re(e=1e3,t=!1){return new Promise((n,r)=>setTimeout(t?r:n,e))}function v(e){let t=[];for(let n=1;n<e.length;n+=2)t.push(e[n]);return t}function x(e){let t=[];for(let n=0;n<e.length;n+=2)t.push(e[n]);return t}function p(e){return e!==null&&typeof e=="object"&&Array.isArray(e)===!1}function ie(e){if(!p(e))throw new Error("isObjectEmpty: input not an object");return Object.getOwnPropertyNames(e)>0}function E(e){return Array.isArray(e)}function oe(e){return typeof e=="function"}function se(e,t){if(t===0)return e.slice(1);if(t<e.length-1)return e.slice(0,t).concat(e.slice(t+1));if(t===e.length-1)return e.slice(0,-1);throw new Error(`Invalid index: ${t}`)}function ue(e,{include:t=[],exclude:n=[],asArray:r=!1,deepClone:i=!1,transform:u}={}){let s;if(t?.length>=1){s={};for(let o=0;o<t.length;o++){if(!Object.hasOwn(e,t[o]))throw new Error(`Unrecognized include key: ${t[o]}`);s[t[o]]=e[t[o]]}}else if(n?.length>=1){s={...e};for(let o=0;o<n.length;o++){if(!Object.hasOwn(e,n[o]))throw new Error(`Unrecognized exclude key: ${n[o]}`);delete s[n[o]]}}else s={...e};return(()=>{if(!r)return s;let o=Object.keys(s),g=o.length,b=new Array(g);for(let d=0;d<g;d++)b[d]={key:o[d],value:s[o[d]]};return b})()}var S=globalThis.window,j=!S&&globalThis.self,L=globalThis.process;function C(){return S&&"browser"||j&&"webWorker"||L&&"node"}function ce(e){return e===C()}function q(){return M("MODE",!0)}function fe(e){return e===q()}function I(e){if(E(e))for(let t=e.length-1;t>=0;t--){let n=I(e[t]);if(n)return n}return p(e)?e[envar]:e}function M(e,t,n="",{required:r=!1,defaultValue:i,staticValue:u,ignoreTarget:s,rename:o}={}){let g=I(e)||u||i;if(r&&!g)throw new Error(`Missing environment variable:${n}`);return s?g:Object.assign(t??{},{[o??n]:g})}function z(e,t=[]){let r=e.prototype;Object.defineProperties(r,{events:{value:[...t,"error"],enumerable:!0,writable:!0},packageListener:{value:P,enumerable:!0,writable:!1},ensureEvent:{value:U,enumerable:!0,writable:!1},on:{value:N,enumerable:!0,writable:!1},once:{value:T,enumerable:!0,writable:!1},hasEvent:{value:F,enumerable:!0,writable:!1},flush:{value:G,enumerable:!0,writable:!1},emit:{value:$,enumerable:!0,writable:!1}})}function P(e,t={}){return{listener:e,persistent:t.persist??!0}}function U(e){if(!Object.hasOwn(this.events,e)){let t=new Error(`Unrecognized event: ${e}`);throw this.emit("error",t),t}}function N(e,t){return this.ensureEvent(e),this.events[e].push(this.packageListener(t,{persist:!0})),()=>this.flush(e,t)}function T(e,t){return this.ensureEvent(e),this.events[e].push(this.packageListener(t,{persist:!1})),()=>this.flush(e,t)}function F(e){return Object.hasOwn(this.events,e)}function G(e,t,n){return/^\*$/.test(e)?Object.keys(this.events).forEach(r=>this.flush(r,t,n)):(this.ensureEvent(e),typeof t=="function"?this.events[e]=this.events[e].filter(r=>r.listener!==t):typeof t=="string"?this.events[e]=this.events[e].filter(r=>r.id!==t):typeof n=="function"?this.events[e]=this.events[e].reduce((r,i)=>n(i)?r:[...r,i],[]):this.events[e]=[],this)}function $(e,...t){return this.ensureEvent(e),[...this.events[e]].forEach(n=>n.listener&&n.listener(...t)),this.events[e]=this.events[e].filter(({listener:n,persistent:r})=>r),this}z.construct=function(){let e={};for(let t=0;t<this.events.length;t++)e[this.events[t]]=[];this.events=e};function B(e,t=[]){let n=e,r=e.prototype,i=v(t),u=x(t);u.forEach((s,o)=>{Object.defineProperty(s.prototype,"name",{enumerable:!0,configurable:!0,get:function(){return i[o]}}),Object.defineProperty(s.prototype,"index",{enumerable:!0,configurable:!0,get:function(){return o}}),Object.defineProperty(r,`get${w(i[o])}State`,{enumerable:!0,configurable:!0,get:function(){return this.states[o]}})}),Object.defineProperty(n,"states",{value:i,enumerable:!0,writable:!0,configurable:!0}),Object.defineProperties(r,{states:{value:u,enumerable:!0,writable:!0,configurable:!0},state:{value:null,enumerable:!0,configurable:!0,writable:!0},getState:{value:D,enumerable:!0,writable:!0,configurable:!0},setState:{value:Q,enumerable:!0,writable:!0,configurable:!0},inState:{value:J,enumerable:!0,writable:!0,configurable:!0},compareStates:{value:_,enumerable:!0,writable:!0,configurable:!0}})}function D(e){if(e){let t=this.states.length;if(typeof e=="string"){for(let n=0;n<t;n++)if(this.states[n].name===e)return this.states[n]}else if(p(e)){for(let n=0;n<t;n++)if(this.states[n].name===e.name)return e}throw new Error(`Unrecognized state: ${e}`)}return this.state}function Q(e){let t=this.state?.name;return typeof e=="string"&&(e=this.getState(e)),this.state=e,typeof this.emit=="function"&&p(this.events)&&this.emit("stateChange",this.state.name,t,this),"init"in this.state&&this.state.init(),this}function J(e){return e===this.state.name||e===this.state.index}function _(e){let t={},n=this.constructor.states.length;for(let r=0;r<n;r++)t[this.constructor.states[r]]=r;return e(t,this.state.index)}B.construct=function(){this.states=this.states.map(e=>new e(this)),this.state=this.states[0]};import*as k from"uuid";function me(){return k.v4()}function be(){return Math.random().toString(34).substring(2)}var H={debug:(...e)=>{},trace:(...e)=>{}},m=class extends Error{constructor(t,n){super(t,{cause:n}),this.name=this.constructor.name}};var a={};a.Idle=function(t){this.name="idle",this.taskRunner=t,this.getState=()=>this};a.Idle.prototype.run=function(t){return t(()=>this.taskRunner.setState(this.taskRunner.isConnected()?"connected":"pending"))};a.Pending=function(t){this.name="pending",this.taskRunner=t,this.getState=()=>this};a.Pending.prototype.init=function(){this.poll()};a.Pending.prototype.poll=function(){let t=setInterval(()=>{if(this.taskRunner.isConnected())return clearInterval(t),this.taskRunner.setState("connected");this.taskRunner.flush(),this.taskRunner.jobQueue.length===0&&(clearInterval(t),this.taskRunner.setState("idle"))},this.taskRunner.pollFrequency)};a.Pending.prototype.run=function(t){return t()};a.Connected=function(t){this.name="connected",this.taskRunner=t,this.getState=()=>this};a.Connected.prototype.init=function(){this.taskRunner.flush(),this.runJobs()};a.Connected.prototype.runJobs=function(){this.taskRunner.jobQueue.length===0?this.taskRunner.setState("idle"):this.taskRunner.isConnected()?(this.taskRunner.jobQueue.shift().exec(),this.runJobs()):this.taskRunner.setState("pending")};a.Connected.prototype.run=function(t){return t(()=>this.runJobs())};function f(e={}){let t=this.parseConf(e);this.timeout=t.timeout,this.logger=t.logger,this.isConnected=t.isConnected,this.pollFrequency=t.pollFrequency,this.jobQueue=[],this.state=null,this.states={idle:new a.Idle(this),pending:new a.Pending(this),connected:new a.Connected(this)},this.setState("idle")}f.prototype.parseConf=function(t){let n={};return n.logger=t.logger||H,n.timeout=t.timeout||3e4,n.pollFrequency=t.pollFrequency||1e3,n.isConnected=t.isConnected?t.isConnected:()=>!1,n};f.prototype.setState=function(e){let t=`[TRANSITION]:taskRunner ${this.state?.name}`;if(this.state=this.states[e],!this.state)throw new m(`Unrecognized state: ${e}`);"init"in this.state&&this.state.init()};f.prototype.queue=function(e){return this.jobQueue.push(e)};f.prototype.flush=function(){let e=Date.now();this.jobQueue=this.jobQueue.filter(t=>(e>=t.timeout&&t.exec(!0),e<t.timeout))};f.prototype.newJob=function(e,t){return n=>new Promise((r,i)=>{t.cb?this.queue({timeout:Date.now()+(t.timeout||this.timeout),exec:u=>{if(u)e(new Error("task timeout"));else try{e()}catch(s){e(new m("Synchronous error",s))}}}):this.queue({timeout:Date.now()+(t.timeout||this.timeout),exec:u=>{if(u)i(new Error("task timeout"));else try{e().then(r,i)}catch(s){i(new m("Synchronous error",s))}}}),n&&n()})};f.prototype.inState=function(e){return e===this.state.name};f.prototype.run=function(e,t){return typeof e=="function"&&(t=e,e={}),this.state.run(this.newJob(t,e))};function h(e,t,...n){this.route=t,this.middleware=n,this.queue=null,this.nextIndex=0;let r=function(i,u){return new h(e,t,...n).exec([e.beforeAll,n.map(o=>[e.beforeEach,o,e.afterEach]),e.afterAll,e.globalLast],i,u)};return r.skipAll=function(i,u){return new h(e,t,...n).exec([this.middleware],i,u)},r.exec=this.exec.bind(this),r}h.prototype.findNextErrHandlerIndex=function(e){let t=this.queue.length;for(;e<t;e++)if(this.queue.at(e).length>2)return e;return-1};h.prototype.runner=async function(e,t,n){this.nextIndex=t;let r=this.queue.at(this.nextIndex);r&&await r(e,this.runner.bind(this,e,t+1),n)};h.prototype.exec=async function(e,t,n){this.queue=e.flat(3),this.nextIndex=0;let r=this.queue.length,i={route:this.route,args:{...t},options:{onlyData:!0,...n},req:{},res:{}},u=null;for(;this.nextIndex<r;)try{await this.runner(i,this.nextIndex,u)}catch(s){if(u=s,this.nextIndex=this.findNextErrHandlerIndex(this.nextIndex+1),this.nextIndex===-1)throw s}return this.queue=null,i?.options?.onlyData?i.res.data:(delete i.args,delete i.options,i)};var l=class{constructor(){this.beforeAll=[],this.beforeEach=[],this.afterAll=[],this.afterEach=[]}};l.prototype.globalLast=async function(t,n,r){if(r)throw r;n()};l.prototype.flush=function(){this.globalLast=null,this.beforeAll.splice(0,this.beforeAll.length),this.beforeEach.splice(0,this.beforeEach.length),this.afterAll.splice(0,this.afterAll.length),this.afterEach.splice(0,this.afterEach.length)};l.prototype.setGlobalLast=function(t){this.globalLast=t};l.prototype.setBeforeAll=function(...t){this.beforeAll.push(...t)};l.prototype.setBeforeEach=function(...t){this.beforeEach.push(...t)};l.prototype.setAfterAll=function(...t){this.afterAll.push(...t)};l.prototype.setAfterEach=function(...t){this.afterEach.push(...t)};l.prototype.route=function(e,...t){return new h(this,e,...t)};export{c as ConsoleLogger,l as Pipeline,f as TaskRunner,ne as areMembersDuplicate,R as areMembersUnique,te as areMembersUniqueCb,w as capitalize,re as delay,q as detectMode,C as detectRuntime,z as eventful,x as extractEvens,v as extractOdds,ue as filterObject,O as flattenObj,A as generateRandomName,M as getEnvar,E as isArray,oe as isFunction,fe as isMode,X as isNumber,p as isObject,ie as isObjectEmpty,ce as isRuntime,Y as randomInteger,ee as randomReal,se as removeIndex,be as smallid,B as stateful,me as uuid,me as uuidv4};
