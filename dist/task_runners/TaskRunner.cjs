var a=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var p=Object.prototype.hasOwnProperty;var f=(e,t)=>{for(var n in t)a(e,n,{get:t[n],enumerable:!0})},g=(e,t,n,u)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of d(t))!p.call(e,i)&&i!==n&&a(e,i,{get:()=>t[i],enumerable:!(u=l(t,i))||u.enumerable});return e};var m=e=>g(a({},"__esModule",{value:!0}),e);var R={};f(R,{TaskRunner:()=>o});module.exports=m(R);var y={debug:(...e)=>{},trace:(...e)=>{}},r=class extends Error{constructor(t,n){super(t,{cause:n}),this.name=this.constructor.name}};var s={};s.Idle=function(t){this.name="idle",this.taskRunner=t,this.getState=()=>this};s.Idle.prototype.run=function(t){return t(()=>this.taskRunner.setState(this.taskRunner.isConnected()?"connected":"pending"))};s.Pending=function(t){this.name="pending",this.taskRunner=t,this.getState=()=>this};s.Pending.prototype.init=function(){this.poll()};s.Pending.prototype.poll=function(){let t=setInterval(()=>{if(this.taskRunner.isConnected())return clearInterval(t),this.taskRunner.setState("connected");this.taskRunner.flush(),this.taskRunner.jobQueue.length===0&&(clearInterval(t),this.taskRunner.setState("idle"))},this.taskRunner.pollFrequency)};s.Pending.prototype.run=function(t){return t()};s.Connected=function(t){this.name="connected",this.taskRunner=t,this.getState=()=>this};s.Connected.prototype.init=function(){this.taskRunner.flush(),this.runJobs()};s.Connected.prototype.runJobs=function(){this.taskRunner.jobQueue.length===0?this.taskRunner.setState("idle"):this.taskRunner.isConnected()?(this.taskRunner.jobQueue.shift().exec(),this.runJobs()):this.taskRunner.setState("pending")};s.Connected.prototype.run=function(t){return t(()=>this.runJobs())};function o(e={}){let t=this.parseConf(e);this.timeout=t.timeout,this.logger=t.logger,this.isConnected=t.isConnected,this.pollFrequency=t.pollFrequency,this.jobQueue=[],this.state=null,this.states={idle:new s.Idle(this),pending:new s.Pending(this),connected:new s.Connected(this)},this.setState("idle")}o.prototype.parseConf=function(t){let n={};return n.logger=t.logger||y,n.timeout=t.timeout||3e4,n.pollFrequency=t.pollFrequency||1e3,n.isConnected=t.isConnected?t.isConnected:()=>!1,n};o.prototype.setState=function(e){let t=`[TRANSITION]:taskRunner ${this.state?.name}`;if(this.state=this.states[e],!this.state)throw new r(`Unrecognized state: ${e}`);"init"in this.state&&this.state.init()};o.prototype.queue=function(e){return this.jobQueue.push(e)};o.prototype.flush=function(){let e=Date.now();this.jobQueue=this.jobQueue.filter(t=>(e>=t.timeout&&t.exec(!0),e<t.timeout))};o.prototype.newJob=function(e,t){return n=>new Promise((u,i)=>{t.cb?this.queue({timeout:Date.now()+(t.timeout||this.timeout),exec:c=>{if(c)e(new Error("task timeout"));else try{e()}catch(h){e(new r("Synchronous error",h))}}}):this.queue({timeout:Date.now()+(t.timeout||this.timeout),exec:c=>{if(c)i(new Error("task timeout"));else try{e().then(u,i)}catch(h){i(new r("Synchronous error",h))}}}),n&&n()})};o.prototype.inState=function(e){return e===this.state.name};o.prototype.run=function(e,t){return typeof e=="function"&&(t=e,e={}),this.state.run(this.newJob(t,e))};
